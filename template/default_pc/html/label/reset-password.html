<strong class="popup-title"
  >{:platform_lang('platform/label/login/welcome')}</strong
>
<div class="popup-holder">
  <form id="fm" action="" data-form="ajax" method="post">
    <input type="hidden" name="ac" value="email" />
    <div class="generic-error hidden"></div>
    <div>
      <div class="row">
        <input
          type="text"
          id="to"
          name="to"
          class="textfield"
          placeholder="{:platform_lang('platform/label/reset-password/enter_email')}"
        />
        <input
          autocomplete="off"
          class="textfield"
          type="button"
          id="btn_send_sms"
          value="{:platform_lang('platform/label/signup/placeholder_get_verify')}"
        />
        <div class="field-error down"></div>
      </div>
      <div class="row">
        <input
          autocomplete="off"
          type="text"
          id="code"
          name="code"
          class="textfield"
          placeholder="{:platform_lang('platform/label/signup/placeholder_email_verify')}"
        />
        <div class="field-error down"></div>
      </div>

      <div class="row">
        <input
          autocomplete="off"
          type="password"
          id="user_pwd"
          name="user_pwd"
          class="textfield"
          placeholder="{:platform_lang('platform/label/reset-password/enter_password')}"
        />
        <div class="field-error down"></div>
      </div>
      <div class="row">
        <input
          autocomplete="off"
          type="password"
          id="user_pwd2"
          name="user_pwd2"
          class="textfield"
          placeholder="{:platform_lang('platform/label/reset-password/comfirm_password')}"
        />
        <div class="field-error down"></div>
      </div>
      <div class="bottom">
        <!-- <label>请输入以下验证码。</label> -->
        <div class="captcha-control">
          <div class="image">
            <div class="diaCode">
              <input
                autocomplete="off"
                type="text"
                id="verify"
                name="verify"
                class="textfield"
                autocomplete="off"
                maxlength="4"
                placeholder="{:platform_lang('platform/label/reset-password/enter_verification')}"
              />
              <img
                src="{:mac_url('verify/index')}"
                onclick="this.src=this.src+'?'"
                alt="{:platform_lang('platform/label/reset-password/refresh_verify')}"
              />
            </div>
            <div class="field-error up"></div>
          </div>
        </div>
        <button class="submit" id="btn_submit">
          {:platform_lang('platform/label/reset-password/resetpassword')}
        </button>
      </div>
    </div>
  </form>
</div>
<script>
  var countdown = 60;

  function settime(val) {
    if (countdown == 0) {
      val.removeAttribute("disabled");
      val.value = "{:platform_lang('platform/user/titp_verify_get')}";
      countdown = 60;
      return true;
    } else {
      val.setAttribute("disabled", true);
      val.value =
        "{:platform_lang('platform/user/titp_resend')}" + "(" + countdown + ")";
      countdown--;
    }
    setTimeout(function () {
      settime(val);
    }, 1000);
  }

  $(function () {
    $("body").bind("keyup", function (event) {
      if (event.keyCode == 13) {
        $("#btnLogin").click();
      }
    });

    $("#btn_send_sms").click(function () {
      var ac = $('input[name="ac"]').val();
      var to = $('input[name="to"]').val();
      if (ac == "email") {
        var pattern =
          /^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;
        var ex = pattern.test(to);
        if (!ex) {
          layer.msg("{:platform_lang('platform/user/titp_email_error')}");
          return;
        }
      } else if (ac == "phone") {
        var pattern = /^[1][0-9]{10}$/;
        var ex = pattern.test(to);
        if (!ex) {
          layer.msg("{:platform_lang('platform/user/titp_phone_error')}");
          return;
        }
      } else {
        layer.msg("{:platform_lang('platform/user/titp_var_error')}");
        return;
      }

      settime(this);
      var data = $("#fm").serialize();

      $.ajax({
        url: "{:mac_url('user/findpass_msg')}",
        type: "post",
        dataType: "json",
        data: data,
        beforeSend: function () {
          //开启loading
        },
        success: function (r) {
          layer.msg(r.msg);
        },
        complete: function () {
          //结束loading
        },
      });
    });

    $("#btn_submit").click(function () {
      if ($("#to").val() == "") {
        layer.msg(
          "{:platform_lang('platform/label/reset-password/enter_email')}"
        );
        $("#to").focus();
        return false;
      }
      if ($("#user_pwd").val() == "") {
        layer.msg(
          "{:platform_lang('platform/label/reset-password/enter_password')}"
        );
        $("#user_pwd").focus();
        return false;
      }
      if ($("#user_pwd2").val() == "") {
        layer.msg(
          "{:platform_lang('platform/label/reset-password/comfirm_password')}"
        );
        $("#user_pwd2").focus();
        return false;
      }
      if ($("#verify").val() == "") {
        layer.msg(
          "{:platform_lang('platform/label/reset-password/enter_verification')}"
        );
        $("#verify").focus();
        return false;
      }

      $.ajax({
        url: "{:mac_url('user/findpass_reset')}",
        type: "post",
        dataType: "json",
        data: $("#fm").serialize(),
        beforeSend: function () {
          $("#btn_submit").val("loading...");
        },
        success: function (r) {
          if (r.code == 1) {
            layer.msg(r.msg);
            location.href = "{:mac_url('index/index')}";
          } else {
            layer.msg(r.msg);
          }
        },
        complete: function () {
          $("#verify").click();
          $("#btn_submit").val("立即找回");
        },
      });
    });
  });
</script>
